<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snakepit C64 - Fixed Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #111;
            color: white;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-top: 20px;
        }
        h1 {
            color: #4CAF50;
            margin-bottom: 5px;
        }
        .subtitle {
            color: #aaa;
            margin-bottom: 20px;
        }
        #gameContainer {
            width: 800px;
            height: 600px;
            position: relative;
            border: 4px solid #333;
            background-color: #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
        }
        #loadingMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: white;
            text-align: center;
            width: 80%;
        }
        #controls {
            margin-top: 20px;
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            width: 800px;
            text-align: center;
        }
        .info {
            background-color: #444;
            border-left: 6px solid #4CAF50;
            padding: 15px;
            margin: 20px 0;
            font-size: 14px;
            text-align: left;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .navigation {
            margin-top: 20px;
        }
        .navigation a {
            color: #4CAF50;
            text-decoration: none;
            margin: 0 10px;
        }
        .navigation a:hover {
            text-decoration: underline;
        }
        #consoleOutput {
            background-color: #222;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            width: 90%;
            height: 120px;
            overflow-y: auto;
            font-family: monospace;
            margin-top: 10px;
            color: #ddd;
            display: none;
        }
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #4CAF50;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <h1>Snakepit C64</h1>
    <div class="subtitle">Original Python Version with JavaScript Fix</div>
    
    <div id="gameContainer">
        <div id="loadingMessage">
            <div class="loading-spinner"></div>
            <div>Loading Python game engine...</div>
            <div style="font-size: 14px; margin-top: 10px; color: #aaa;">This may take a few moments</div>
        </div>
    </div>
    
    <div id="controls">
        <button id="startButton">Start Game</button>
        <button id="reloadButton">Reload</button>
        <button id="showConsoleButton">Toggle Console</button>
        
        <div class="info">
            <p><strong>Controls:</strong> Arrow keys to move, P to pause, ESC to quit</p>
            <p><strong>Note:</strong> Click on the game area to capture keyboard focus</p>
        </div>
        
        <div id="consoleOutput"></div>
    </div>
    
    <div class="navigation">
        <a href="index2.html">Back to Options</a> | 
        <a href="debug.html">Troubleshooting</a>
    </div>
    
    <script>
        // Console logging output
        const consoleOutput = document.getElementById('consoleOutput');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        console.log = function() {
            // Call the original function
            originalConsoleLog.apply(console, arguments);
            
            // Add to our console display
            const args = Array.from(arguments);
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg);
                } else {
                    return String(arg);
                }
            }).join(' ');
            
            if (consoleOutput) {
                consoleOutput.innerHTML += `<div style="color: #4CAF50;">[LOG] ${message}</div>`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        };
        
        console.error = function() {
            // Call the original function
            originalConsoleError.apply(console, arguments);
            
            // Add to our console display
            const args = Array.from(arguments);
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg);
                } else {
                    return String(arg);
                }
            }).join(' ');
            
            if (consoleOutput) {
                consoleOutput.innerHTML += `<div style="color: #FF6347;">[ERROR] ${message}</div>`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        };
        
        document.getElementById('showConsoleButton').addEventListener('click', () => {
            consoleOutput.style.display = consoleOutput.style.display === 'none' ? 'block' : 'none';
        });
        
        // Function to create a patched version of the pythons.js script
        function loadPatchedPythonsJs() {
            return new Promise((resolve, reject) => {
                console.log("Fetching pythons.js to apply patches...");
                // First, load the original script to intercept and patch
                fetch('https://pygame-web.github.io/archives/0.8/pythons.js')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch pythons.js: ${response.status} ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(originalCode => {
                        // Patch the code that causes "Assignment to constant variable" error
                        console.log("Applying patches to pythons.js...");
                        let patchedCode = originalCode;
                        
                        // Multiple replacements for all instances that might cause errors
                        const replacements = [
                            // Main function causing errors
                            [/const\s+auto_start\s*=\s*async\s*function/g, 'let auto_start = async function'],
                            [/const\s+auto_conf\s*=\s*function/g, 'let auto_conf = function'],
                            
                            // Other potential problem areas
                            [/const\s+config\s*=/g, 'let config ='],
                            [/const\s+srcurl\s*=/g, 'let srcurl ='],
                            [/const\s+docurl\s*=/g, 'let docurl ='],
                            [/const\s+interpreter\s*=/g, 'let interpreter ='],
                            [/const\s+argv\s*=/g, 'let argv =']
                        ];
                        
                        // Apply all replacements
                        replacements.forEach(([pattern, replacement]) => {
                            const oldCode = patchedCode;
                            patchedCode = patchedCode.replace(pattern, replacement);
                            
                            // Log if replacement was made
                            if (oldCode !== patchedCode) {
                                console.log(`Patched: ${pattern}`);
                            }
                        });
                        
                        // Create a blob and URL for the patched script
                        const blob = new Blob([patchedCode], {type: 'application/javascript'});
                        const scriptURL = URL.createObjectURL(blob);
                        
                        console.log("Patch complete, loading modified script...");
                        
                        // Create script element for the patched code
                        const scriptElement = document.createElement('script');
                        scriptElement.src = scriptURL;
                        scriptElement.onload = () => {
                            console.log("âœ“ Patched pythons.js loaded successfully");
                            resolve();
                        };
                        scriptElement.onerror = (error) => {
                            console.error("Failed to load patched script", error);
                            reject(error);
                        };
                        
                        // Add to document to execute
                        document.head.appendChild(scriptElement);
                    })
                    .catch(error => {
                        console.error("Error fetching original script:", error);
                        reject(error);
                    });
            });
        }
        
        // Function to create and load the iframe
        function setupGame() {
            const gameContainer = document.getElementById('gameContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            
            // Create iframe for the game
            const iframe = document.createElement('iframe');
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.style.display = 'none'; // Hide initially
            
            // Create the content for the iframe
            const iframeContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Snakepit C64</title>
                    <style>
                        body { margin: 0; overflow: hidden; background-color: #000; }
                    </style>
                    <script>
                        window.addEventListener('error', function(event) {
                            // Send error details to parent window
                            window.parent.postMessage({
                                type: 'error',
                                message: event.message,
                                source: event.filename,
                                line: event.lineno,
                                column: event.colno
                            }, '*');
                            return false;
                        });
                    </script>
                </head>
                <body>
                    <script 
                        id="pygbag"
                        type="application/javascript"
                        src="https://pygame-web.github.io/archives/0.8/pythons.js"
                        data-archive="massdb8"
                        data-ume_block="0"
                        data-can_close="1"
                        data-autorun="1"
                        data-gui_debug="0"
                        data-PYBUILD="3.12"
                    ></script>
                </body>
                </html>
            `;
            
            // Game started flag
            let gameStarted = false;
            
            // Add the iframe to the page
            gameContainer.appendChild(iframe);
            
            // Listen for messages from the iframe
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'error') {
                    console.error(`Error in game: ${event.data.message} at ${event.data.source}:${event.data.line}:${event.data.column}`);
                }
            });
            
            // Use the start button to control the game
            document.getElementById('startButton').addEventListener('click', () => {
                if (!gameStarted) {
                    loadingMessage.style.display = 'none';
                    iframe.style.display = 'block';
                    
                    // Write the content to the iframe
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    iframeDoc.open();
                    iframeDoc.write(iframeContent);
                    iframeDoc.close();
                    
                    console.log("Game iframe initialized");
                    
                    // Mark game as started
                    gameStarted = true;
                    
                    // Update button text
                    document.getElementById('startButton').textContent = 'Game Running';
                    document.getElementById('startButton').disabled = true;
                } else {
                    // Game is already running
                    iframe.focus();
                }
            });
            
            // Reload button
            document.getElementById('reloadButton').addEventListener('click', () => {
                location.reload();
            });
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Initializing fixed version...");
            
            loadPatchedPythonsJs()
                .then(() => {
                    console.log("Patched script loaded, setting up game...");
                    setupGame();
                })
                .catch(err => {
                    console.error("Error in setup:", err);
                    document.getElementById('loadingMessage').innerHTML = `
                        <div style="color: #FF6347;">Error loading patched script:</div>
                        <div>${err}</div>
                        <div style="margin-top: 20px;">
                            Please try the <a href="manual.html" style="color:#4CAF50;">manual version</a> or 
                            <a href="backup.html" style="color:#4CAF50;">fallback version</a>
                        </div>
                    `;
                });
        });
    </script>
</body>
</html> 